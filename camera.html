<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Camera + GPS + Watermark Absensi</title>
  <style>
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      color:#111;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      padding:18px;
      max-width:900px;
      margin:0 auto;
    }
    .stage{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:center;
      width:100%;
    }
    video{
      border-radius:8px;
      max-width:100%;
      width:360px;
      background:#000;
    }
    canvas{
      display:block;
      border-radius:8px;
      width:360px;
      max-width:100%;
    }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:8px;
    }
    button,select{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-size:14px;
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .thumb{
      max-width:200px;
      border-radius:8px;
    }
    .note{
      font-size:13px;
      color:#555;
      text-align:center;
    }
    pre{
      background:#f5f5f5;
      padding:10px;
      border-radius:8px;
      white-space:pre-wrap;
      font-size:12px;
      max-width:100%;
      overflow:auto;
    }
    h1{
      font-size:20px;
      text-align:center;
      margin-bottom:4px;
    }
  </style>
</head>
<body>
  <h1>Camera + GPS + Watermark Absensi</h1>
  <p class="note">
    Watermark ala aplikasi absensi: kotak “Absensi + jam” di kiri bawah, dengan tanggal, alamat, dan kode foto.
  </p>

  <div class="stage">
    <div>
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
      <div class="controls">
        <button id="startBtn">Mulai Kamera</button>
        <button id="stopBtn" disabled>Berhenti</button>
        <button id="captureBtn" disabled>Ambil Foto</button>

        <label for="facing">Kamera:</label>
        <select id="facing">
          <option value="user">Depan (user)</option>
          <option value="environment">Belakang (environment)</option>
          <option value="auto" selected>Auto</option>
        </select>

        <button id="flipBtn" title="Ganti kamera (jika tersedia)">Ganti Kamera</button>
        <button id="downloadBtn" disabled>Download Foto</button>
      </div>
    </div>

    <div>
      <h3>Preview Foto</h3>
      <img id="photo" class="thumb" alt="Foto preview" />
      <h3>Info Lokasi</h3>
      <pre id="infoLokasi">Belum ada data lokasi.</pre>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const captureBtn = document.getElementById('captureBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const flipBtn = document.getElementById('flipBtn');
    const facingSelect = document.getElementById('facing');
    const photoImg = document.getElementById('photo');
    const infoLokasi = document.getElementById('infoLokasi');

    let stream = null;
    let currentFacingMode = 'auto';
    let currentDeviceId = null;
    let videoTracks = [];

    // ===== KONFIGURASI WATERMARK ABSENSI =====
    const WM_MARGIN = 24;      // jarak dari tepi kiri & bawah
    const WM_PADDING = 10;     // padding di sekitar teks utama
    const WM_FONT_TITLE = "bold 18px system-ui";
    const WM_FONT_TIME  = "bold 22px system-ui";
    const WM_FONT_TEXT  = "14px system-ui";
    const WM_FONT_CODE  = "12px system-ui";

    function formatTanggalIndo(date) {
      const hari = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
      const pad = n => n.toString().padStart(2, '0');
      const h = hari[date.getDay()];
      return `${h}, ${pad(date.getDate())}/${pad(date.getMonth()+1)}/${date.getFullYear()}`;
    }
    function formatJam(date) {
      const pad = n => n.toString().padStart(2, '0');
      return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    async function startCamera() {
      stopCamera();
      const facing = facingSelect.value;
      currentFacingMode = facing;

      const constraints = {
        audio: false,
        video: {
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      };

      if (facing === 'user' || facing === 'environment') {
        constraints.video.facingMode = { exact: facing };
      } else if (currentDeviceId) {
        constraints.video.deviceId = { exact: currentDeviceId };
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        handleStream(stream);
      } catch (err) {
        try {
          delete constraints.video.facingMode;
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          handleStream(stream);
        } catch (err2) {
          alert('Gagal mengakses kamera: ' + (err2.message || err.message));
          console.error(err, err2);
        }
      }
    }

    function handleStream(s) {
      stream = s;
      video.srcObject = stream;
      videoTracks = stream.getVideoTracks();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      captureBtn.disabled = false;
      downloadBtn.disabled = true;
      if (videoTracks.length) {
        const settings = videoTracks[0].getSettings();
        currentDeviceId = settings.deviceId || currentDeviceId;
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      captureBtn.disabled = true;
    }

    // ===== AMBIL GPS + REVERSE GEOCODING =====
    function getLocationInfo() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          resolve({
            success: false,
            message: "Browser tidak mendukung Geolocation.",
            lat: null,
            lng: null,
            kota: null,
            alamat: null
          });
          return;
        }

        infoLokasi.textContent = "Mengambil lokasi GPS...";

        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const acc = pos.coords.accuracy;

            let baseInfo =
              "Latitude : " + lat + "\n" +
              "Longitude: " + lng + "\n" +
              "Akurasi : ~" + Math.round(acc) + " meter\n";

            try {
              infoLokasi.textContent = baseInfo + "\nMencari nama kota (reverse geocoding)...";

              const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
              const res = await fetch(url, {
                headers: {
                  "Accept": "application/json",
                  "User-Agent": "camera-gps-watermark-demo"
                }
              });
              const data = await res.json();
              const addr = data.address || {};
              const kota = addr.city || addr.town || addr.village || addr.county || "Tidak diketahui";
              const negara = addr.country || "";
              const jalan = addr.road || "";
              const desa = addr.suburb || addr.hamlet || "";
              const kec = addr.state_district || addr.county || "";
              const kodePos = addr.postcode || "";

              let alamatText =
                (jalan ? jalan + ", " : "") +
                (desa ? desa + ", " : "") +
                (kota ? kota + ", " : "") +
                (kec ? kec + ", " : "") +
                (negara ? negara + ", " : "") +
                (kodePos ? kodePos : "");

              baseInfo +=
                "\nPerkiraan Kota : " + kota +
                "\nAlamat Singkat : " + alamatText;

              infoLokasi.textContent = baseInfo;

              resolve({
                success: true,
                message: "OK",
                lat,
                lng,
                kota,
                alamat: alamatText
              });
            } catch (e) {
              baseInfo += "\n\nGagal mengambil nama kota dari server: " + e.message;
              infoLokasi.textContent = baseInfo;
              resolve({
                success: true,
                message: "GPS OK, reverse geocoding gagal",
                lat,
                lng,
                kota: null,
                alamat: null
              });
            }
          },
          (err) => {
            infoLokasi.textContent = "Gagal mengambil lokasi: " + err.message;
            resolve({
              success: false,
              message: err.message,
              lat: null,
              lng: null,
              kota: null,
              alamat: null
            });
          },
          {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
          }
        );
      });
    }

    function generateFotoCode() {
      // kode acak sederhana ala "3KMKNGU…"
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let code = "";
      for (let i = 0; i < 12; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    async function capturePhotoWithWatermark() {
      if (!video || video.readyState < 2) return;

      const lokasi = await getLocationInfo();
      const now = new Date();
      const tanggalStr = formatTanggalIndo(now);
      const jamStr = formatJam(now);
      const kodeFoto = generateFotoCode();

      // alamat untuk baris-baris bawah
      const alamatStr = lokasi && lokasi.alamat
        ? lokasi.alamat
        : "Alamat tidak tersedia";

      // canvas & gambar utama
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // ===== WATERMARK ALA APLIKASI ABSENSI (KIRI BAWAH) =====
      ctx.save();

      const marginX = WM_MARGIN;
      const marginY = WM_MARGIN;

      // ---- 1) Kotak "Absensi | JAM" ----
      // hitung ukuran teks
      ctx.font = WM_FONT_TITLE;
      const labelText = "Absensi";
      const labelWidth = ctx.measureText(labelText).width;

      ctx.font = WM_FONT_TIME;
      const timeText = jamStr;
      const timeWidth = ctx.measureText(timeText).width;

      const gapBetween = 8; // jarak antara kotak kuning dan biru
      const boxHeight = 34;

      const box1Width = labelWidth + 20; // padding
      const box2Width = timeWidth + 20;

      const totalWidth = box1Width + gapBetween + box2Width;

      const boxY = canvas.height - marginY - boxHeight;
      const box1X = marginX;
      const box2X = marginX + box1Width + gapBetween;

      // kotak kuning (Absensi)
      ctx.fillStyle = "#FFB800"; // kuning
      ctx.roundRect(box1X, boxY, box1Width, boxHeight, 6);
      ctx.fill();

      // kotak biru (jam)
      ctx.fillStyle = "#003C9F"; // biru tua
      ctx.roundRect(box2X, boxY, box2Width, boxHeight, 6);
      ctx.fill();

      // teks "Absensi"
      ctx.font = WM_FONT_TITLE;
      ctx.fillStyle = "#1F1F1F";
      ctx.textBaseline = "middle";
      ctx.fillText(labelText, box1X + 10, boxY + boxHeight / 2);

      // teks jam
      ctx.font = WM_FONT_TIME;
      ctx.fillStyle = "#FFFFFF";
      ctx.fillText(timeText, box2X + 10, boxY + boxHeight / 2);

      // ---- 2) Teks tanggal dan alamat di bawahnya ----
      const textStartX = marginX;
      let textY = boxY - 8; // mulai tepat di atas kotak

      // background hitam transparan di belakang teks (agar terbaca)
      const textBlockPadding = 10;
      const lines = [
        tanggalStr,
        alamatStr
      ];

      ctx.font = WM_FONT_TEXT;
      let maxLineWidth = 0;
      for (const line of lines) {
        const w = ctx.measureText(line).width;
        if (w > maxLineWidth) maxLineWidth = w;
      }

      const lineHeight = 18;
      const blockHeight = lines.length * lineHeight + textBlockPadding * 2;
      const blockWidth = maxLineWidth + textBlockPadding * 2;

      const blockX = textStartX - 4;
      const blockY = textY - blockHeight;

      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.roundRect(blockX, blockY, blockWidth, blockHeight, 8);
      ctx.fill();

      // teks putih
      ctx.fillStyle = "#FFFFFF";
      ctx.textBaseline = "top";
      let curY = blockY + textBlockPadding;
      for (const line of lines) {
        ctx.fillText(line, blockX + textBlockPadding, curY);
        curY += lineHeight;
      }

      // ---- 3) Kode foto abu-abu di bawah (kecil) ----
      const kodeLabel = "Kode Foto: " + kodeFoto;
      ctx.font = WM_FONT_CODE;
      const kodeWidth = ctx.measureText(kodeLabel).width;
      const kodeHeight = 16;

      const kodeX = marginX;
      const kodeY = boxY + boxHeight + 6;

      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.roundRect(kodeX - 4, kodeY - 2, kodeWidth + 8, kodeHeight + 6, 6);
      ctx.fill();

      ctx.fillStyle = "rgba(220,220,220,0.9)";
      ctx.textBaseline = "top";
      ctx.fillText(kodeLabel, kodeX, kodeY);

      ctx.restore();
      // ===== END WATERMARK =====

      const dataUrl = canvas.toDataURL('image/png');
      photoImg.src = dataUrl;

      downloadBtn.href = dataUrl;
      downloadBtn.download = `absensi-${now.toISOString().replace(/[:.]/g,'-')}.png`;
      downloadBtn.disabled = false;
      canvas.style.display = 'block';
    }

    async function flipCamera() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        if (videoDevices.length < 2) {
          return alert('Tidak ada kamera lain yang terdeteksi.');
        }
        const idx = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
        const next = videoDevices[(idx + 1) % videoDevices.length];
        currentDeviceId = next.deviceId;
        facingSelect.value = 'auto';
        await startCamera();
      } catch (err) {
        console.error(err);
        alert('Gagal mengganti kamera.');
      }
    }

    // Polyfill roundRect kalau belum ada
    if (!CanvasRenderingContext2D.prototype.roundRect) {
      CanvasRenderingContext2D.prototype.roundRect = function (x, y, width, height, radius) {
        if (typeof radius === "number") {
          radius = { tl: radius, tr: radius, br: radius, bl: radius };
        } else {
          radius = Object.assign({ tl: 0, tr: 0, br: 0, bl: 0 }, radius);
        }
        this.beginPath();
        this.moveTo(x + radius.tl, y);
        this.lineTo(x + width - radius.tr, y);
        this.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
        this.lineTo(x + width, y + height - radius.br);
        this.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
        this.lineTo(x + radius.bl, y + height);
        this.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
        this.lineTo(x, y + radius.tl);
        this.quadraticCurveTo(x, y, x + radius.tl, y);
        this.closePath();
        return this;
      };
    }

    // ===== EVENT LISTENERS =====
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    captureBtn.addEventListener('click', capturePhotoWithWatermark);
    flipBtn.addEventListener('click', flipCamera);

    video.addEventListener('keydown', (e) => {
      if (e.code === 'Space') capturePhotoWithWatermark();
    });

    downloadBtn.addEventListener('click', (e) => {
      if (!photoImg.src) e.preventDefault();
    });

    window.addEventListener('pagehide', stopCamera);

    facingSelect.addEventListener('change', () => {
      if (stream) startCamera();
    });

    (async function precheck(){
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        if (videoDevices.length === 1) flipBtn.disabled = true;
      }catch(e){/* ignore */}
    })();
  </script>
</body>
</html>
