<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Camera Capture — Ambil Foto</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;color:#111;display:flex;flex-direction:column;gap:12px;align-items:center;padding:18px}
    .stage{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    video{border-radius:8px;max-width:100%;width:360px;background:#000}
    canvas{display:block;border-radius:8px;width:360px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button,select{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .thumb{max-width:160px;border-radius:8px}
    .note{font-size:13px;color:#555}
  </style>
</head>
<body>
  <h1>Camera Capture — Ambil Foto</h1>
  <p class="note">Izinkan akses kamera saat diminta. Cocok di desktop & mobile (browser modern).</p>

  <div class="stage">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <div class="controls">
    <button id="startBtn">Mulai Kamera</button>
    <button id="stopBtn" disabled>Berhenti</button>
    <button id="captureBtn" disabled>Ambil Foto</button>

    <label for="facing">Kamera:</label>
    <select id="facing">
      <option value="user">Depan (user)</option>
      <option value="environment">Belakang (environment)</option>
      <option value="auto" selected>Auto</option>
    </select>

    <button id="downloadBtn" disabled>Download Foto</button>
    <button id="flipBtn" title="Ganti kamera (jika tersedia)">Ganti Kamera</button>
  </div>

  <div id="output">
    <h3>Preview</h3>
    <img id="photo" class="thumb" alt="Foto preview" />
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const captureBtn = document.getElementById('captureBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const flipBtn = document.getElementById('flipBtn');
    const facingSelect = document.getElementById('facing');
    const photoImg = document.getElementById('photo');

    let stream = null;
    let currentFacingMode = 'auto';
    let currentDeviceId = null;
    let videoTracks = [];

    async function startCamera() {
      stopCamera();
      const facing = facingSelect.value;
      currentFacingMode = facing;

      const constraints = {
        audio: false,
        video: {
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      };

      if (facing === 'user' || facing === 'environment') {
        constraints.video.facingMode = { exact: facing };
      } else if (currentDeviceId) {
        constraints.video.deviceId = { exact: currentDeviceId };
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        handleStream(stream);
      } catch (err) {
        // fallback: try without exact facingMode
        try {
          delete constraints.video.facingMode;
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          handleStream(stream);
        } catch (err2) {
          alert('Gagal mengakses kamera: ' + (err2.message || err.message));
          console.error(err, err2);
        }
      }
    }

    function handleStream(s) {
      stream = s;
      video.srcObject = stream;
      videoTracks = stream.getVideoTracks();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      captureBtn.disabled = false;
      downloadBtn.disabled = true;
      // store device id of first track
      if (videoTracks.length) currentDeviceId = videoTracks[0].getSettings().deviceId || currentDeviceId;
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      captureBtn.disabled = true;
    }

    function capturePhoto() {
      if (!video || video.readyState < 2) return;
      // set canvas size same as video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/png');
      photoImg.src = dataUrl;
      downloadBtn.href = dataUrl;
      downloadBtn.download = `photo-${new Date().toISOString().replace(/[:.]/g,'-')}.png`;
      downloadBtn.disabled = false;
      canvas.style.display = 'block';
    }

    async function flipCamera() {
      // try enumerate devices and pick a different video device
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        if (videoDevices.length < 2) return alert('Tidak ada kamera lain yang terdeteksi.');
        // find index of current device
        const idx = videoDevices.findIndex(d => d.deviceId === currentDeviceId);
        const next = videoDevices[(idx + 1) % videoDevices.length];
        currentDeviceId = next.deviceId;
        facingSelect.value = 'auto';
        await startCamera();
      } catch (err) {
        console.error(err);
        alert('Gagal mengganti kamera.');
      }
    }

    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    captureBtn.addEventListener('click', capturePhoto);
    flipBtn.addEventListener('click', flipCamera);

    // allow pressing space to capture when video focused
    video.addEventListener('keydown', (e) => {
      if (e.code === 'Space') capturePhoto();
    });

    // set download link action
    downloadBtn.addEventListener('click', (e) => {
      if (!photoImg.src) e.preventDefault();
    });

    // on page unload stop camera
    window.addEventListener('pagehide', stopCamera);

    // try set initial facing from select
    facingSelect.addEventListener('change', () => {
      // restart camera automatically if running
      if (stream) startCamera();
    });

    // helpful: if browser supports getUserMedia constraints, try to pre-select facing
    (async function precheck(){
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return;
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        if (videoDevices.length === 1) flipBtn.disabled = true;
      }catch(e){/* ignore */}
    })();
  </script>
</body>
</html>
