<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deteksi Lokasi — Peta</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+tdbopY0G2Xq6wQv2ZKk6QeNQw9v+0p2p3pJb6u2M=" crossorigin=""/>
  <style>
    :root{--bg:#f7fafc;--card:#ffffff;--accent:#2563eb}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .app{display:flex;flex-direction:column;height:100vh}
    header{background:var(--accent);color:#fff;padding:12px 16px;font-weight:600}
    main{display:flex;flex:1;gap:12px;padding:12px;align-items:stretch}
    .map{flex:1;border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(10,10,10,0.08)}
    #map{height:100%;min-height:320px}
    .panel{width:320px;max-width:40%;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(10,10,10,0.06);display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px}
    button{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.secondary{background:#6b7280}
    .coords{background:#f1f5f9;padding:8px;border-radius:8px;font-family:monospace}
    .small{font-size:13px;color:#374151}
    footer{font-size:12px;color:#4b5563;padding:8px 12px}
    @media(max-width:800px){main{flex-direction:column}.panel{width:100%;max-width:none}}
  </style>
</head>
<body>
  <div class="app">
    <header>Deteksi Lokasi &amp; Peta — OpenStreetMap + Leaflet</header>
    <main>
      <div class="map">
        <div id="map"></div>
      </div>
      <aside class="panel">
        <div class="row">
          <button id="btn-locate">Deteksi Lokasi</button>
          <button id="btn-follow" class="secondary">Ikuti</button>
        </div>
        <div>
          <div class="small">Koordinat</div>
          <div id="coords" class="coords">Belum tersedia</div>
        </div>
        <div>
          <div class="small">Akurasi</div>
          <div id="accuracy" class="coords">-</div>
        </div>
        <div class="row">
          <button id="btn-copy" class="secondary">Salin Koordinat</button>
          <button id="btn-open" class="secondary">Buka di Google Maps</button>
        </div>
        <div class="small">Catatan: Browser membutuhkan koneksi HTTPS (atau localhost) agar akses lokasi berfungsi.</div>
      </aside>
    </main>
    <footer>Tile: OpenStreetMap | Library: Leaflet</footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j8n6bQYb1t7g8gk8uY0q3bKq7X+q0s3Z1FvC0jY=" crossorigin=""></script>
  <script>
    // Inisialisasi peta
    const map = L.map('map', {zoomControl:true}).setView([0,0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = null;
    let accuracyCircle = null;
    let following = false;

    const coordsEl = document.getElementById('coords');
    const accEl = document.getElementById('accuracy');
    const btnLocate = document.getElementById('btn-locate');
    const btnCopy = document.getElementById('btn-copy');
    const btnOpen = document.getElementById('btn-open');
    const btnFollow = document.getElementById('btn-follow');

    function showPosition(pos){
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const acc = pos.coords.accuracy;

      coordsEl.textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      accEl.textContent = `${acc.toFixed(1)} meter`;

      if (!marker) {
        marker = L.marker([lat,lon]).addTo(map);
      } else {
        marker.setLatLng([lat,lon]);
      }

      if (!accuracyCircle) {
        accuracyCircle = L.circle([lat,lon], {radius: acc}).addTo(map);
      } else {
        accuracyCircle.setLatLng([lat,lon]);
        accuracyCircle.setRadius(acc);
      }

      if (following) {
        map.setView([lat,lon], 17, {animate:true});
      } else if (map.getZoom() < 13) {
        map.setView([lat,lon], 13);
      }
    }

    function handleError(err){
      console.warn('Geolocation error', err);
      switch(err.code){
        case err.PERMISSION_DENIED:
          alert('Izin lokasi ditolak. Aktifkan izin lokasi pada browser.'); break;
        case err.POSITION_UNAVAILABLE:
          alert('Lokasi tidak tersedia.'); break;
        case err.TIMEOUT:
          alert('Permintaan lokasi timeout. Coba lagi.'); break;
        default:
          alert('Terjadi kesalahan saat mendapatkan lokasi.');
      }
    }

    function detectLocation(){
      if (!navigator.geolocation) {
        alert('Geolocation tidak didukung di browser ini.');
        return;
      }
      navigator.geolocation.getCurrentPosition(showPosition, handleError, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
    }

    btnLocate.addEventListener('click', ()=>{
      detectLocation();
    });

    btnFollow.addEventListener('click', ()=>{
      following = !following;
      btnFollow.textContent = following ? 'Stop Ikut' : 'Ikuti';
      if (following) {
        // start watching
        if (!navigator.geolocation) return;
        watchId = navigator.geolocation.watchPosition(showPosition, handleError, {enableHighAccuracy:true, timeout:10000, maximumAge:0});
        btnFollow._watchId = watchId;
      } else {
        if (btnFollow._watchId) navigator.geolocation.clearWatch(btnFollow._watchId);
      }
    });

    btnCopy.addEventListener('click', ()=>{
      const text = coordsEl.textContent;
      if (!text || text === 'Belum tersedia') return alert('Belum ada koordinat untuk disalin.');
      navigator.clipboard.writeText(text).then(()=>alert('Koordinat disalin: ' + text)).catch(()=>alert('Gagal menyalin.'));
    });

    btnOpen.addEventListener('click', ()=>{
      const text = coordsEl.textContent;
      if (!text || text === 'Belum tersedia') return alert('Belum ada koordinat.');
      const [lat,lon] = text.split(',').map(s=>s.trim());
      const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      window.open(url, '_blank');
    });

    // Deteksi otomatis saat halaman dibuka (opsional)
    // detectLocation();

  </script>
</body>
</html>
